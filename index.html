<!DOCTYPE html>
<html>
<head>
    <title>Stickman Sniper: Extraction Point</title>
    <style>
        body { text-align: center; background: #000; color: #0f0; font-family: 'Courier New', monospace; margin: 0; overflow: hidden; }
        canvas { background: #050505; border: 2px solid #222; cursor: crosshair; margin-top: 10px; box-shadow: 0 0 20px rgba(0,255,0,0.1); }
        #ui { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); pointer-events: none; width: 800px; display: flex; justify-content: space-between; font-weight: bold; text-shadow: 2px 2px #000; font-size: 18px; }
        .controls { color: #444; font-size: 12px; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="ui">
        <div id="livesText">LIVES: 3 | HITS: 0/2</div>
        <div id="scoreText">TARGETS: 0/20</div>
    </div>
    <canvas id="gameCanvas" width="800" height="450"></canvas>
    <div class="controls">SPACE: Scope | LEFT CLICK: Fire | ARROWS: Move/Jump</div>

<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

// --- GAME STATE ---
let state = 'LEVEL1'; 
let lives = 3;
let hitsTaken = 0;
let targetsEliminated = 0;
let keys = {};
let mouse = { x: 400, y: 225, clicked: false };
let audioCtx = null;

// --- ENTITIES ---
const player = { 
    x: 30, y: 300, vx: 0, vy: 0, 
    grounded: false, recoil: 0, 
    muzzleFlash: 0, winAnimY: 350 
};

const safePlatforms = [
    { x: 0, y: 350, w: 100, h: 100 }, 
    { x: 740, y: 350, w: 60, h: 100 }
];

const elevators = [
    { x: 150, y: 200, w: 75, h: 15, dir: 1, speed: 2 },
    { x: 300, y: 100, w: 75, h: 15, dir: -1, speed: 3 },
    { x: 450, y: 300, w: 75, h: 15, dir: 1, speed: 1.5 },
    { x: 600, y: 150, w: 75, h: 15, dir: -1, speed: 2.5 }
];

let currentEnemy = null;
let heli = { x: -250, y: 80, phase: 'approaching' };

// --- AUDIO ENGINE ---
function initAudio() {
    if (audioCtx) return;
    audioCtx = new (window.AudioContext || window.webkitAudioContext)();
    // Ambient Spooky Drone
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type = 'triangle';
    osc.frequency.setValueAtTime(55, audioCtx.currentTime);
    gain.gain.setValueAtTime(0.02, audioCtx.currentTime);
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start();
}

function playSniperShot() {
    if (!audioCtx) return;
    // 1. High Frequency Crack
    const osc1 = audioCtx.createOscillator();
    const g1 = audioCtx.createGain();
    osc1.type = 'sawtooth';
    osc1.frequency.setValueAtTime(900, audioCtx.currentTime);
    osc1.frequency.exponentialRampToValueAtTime(100, audioCtx.currentTime + 0.1);
    g1.gain.setValueAtTime(0.3, audioCtx.currentTime);
    g1.gain.linearRampToValueAtTime(0, audioCtx.currentTime + 0.1);
    osc1.connect(g1); g1.connect(audioCtx.destination);
    // 2. Low Thump
    const osc2 = audioCtx.createOscillator();
    const g2 = audioCtx.createGain();
    osc2.type = 'triangle';
    osc2.frequency.setValueAtTime(120, audioCtx.currentTime);
    g2.gain.setValueAtTime(0.5, audioCtx.currentTime);
    g2.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.4);
    osc2.connect(g2); g2.connect(audioCtx.destination);
    // 3. Noise/Blast
    const bufferSize = audioCtx.sampleRate * 0.4;
    const buffer = audioCtx.createBuffer(1, bufferSize, audioCtx.sampleRate);
    const data = buffer.getChannelData(0);
    for (let i = 0; i < bufferSize; i++) data[i] = Math.random() * 2 - 1;
    const noise = audioCtx.createBufferSource();
    noise.buffer = buffer;
    const nGain = audioCtx.createGain();
    nGain.gain.setValueAtTime(0.2, audioCtx.currentTime);
    nGain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.3);
    noise.connect(nGain); nGain.connect(audioCtx.destination);

    osc1.start(); osc2.start(); noise.start();
    osc1.stop(audioCtx.currentTime + 0.1);
    osc2.stop(audioCtx.currentTime + 0.4);
    noise.stop(audioCtx.currentTime + 0.3);

    // Shell Casing Tink
    setTimeout(() => {
        const t = audioCtx.createOscillator();
        const tg = audioCtx.createGain();
        t.type = 'sine'; t.frequency.setValueAtTime(2800, audioCtx.currentTime);
        tg.gain.setValueAtTime(0.03, audioCtx.currentTime);
        tg.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 0.05);
        t.connect(tg); tg.connect(audioCtx.destination);
        t.start(); t.stop(audioCtx.currentTime + 0.05);
    }, 450);
}

function playSound(freq, duration, type='square', vol=0.1) {
    if (!audioCtx) return;
    const o = audioCtx.createOscillator();
    const g = audioCtx.createGain();
    o.type = type; o.frequency.setValueAtTime(freq, audioCtx.currentTime);
    g.gain.setValueAtTime(vol, audioCtx.currentTime);
    g.gain.linearRampToValueAtTime(0, audioCtx.currentTime + duration);
    o.connect(g); g.connect(audioCtx.destination);
    o.start(); o.stop(audioCtx.currentTime + duration);
}

// --- INPUTS ---
window.onkeydown = e => { keys[e.code] = true; initAudio(); };
window.onkeyup = e => keys[e.code] = false;
canvas.onmousemove = e => {
    const rect = canvas.getBoundingClientRect();
    mouse.x = e.clientX - rect.left;
    mouse.y = e.clientY - rect.top;
};
canvas.onmousedown = () => { mouse.clicked = true; initAudio(); };

function spawnEnemy() {
    currentEnemy = { 
        x: 150 + Math.random() * 550, 
        y: 200 + Math.random() * 40, 
        timer: 0, 
        maxTime: 180 // 3 Seconds
    };
}

function update() {
    if (state === 'LEVEL1') {
        player.vy += 0.8;
        if (keys['ArrowLeft']) player.vx = -4;
        else if (keys['ArrowRight']) player.vx = 4;
        else player.vx *= 0.8;
        if (keys['ArrowUp'] && player.grounded) { player.vy = -13; player.grounded = false; }
        player.x += player.vx; player.y += player.vy;
        player.grounded = false;

        // Death Floor
        if (player.y > 400) { 
            lives--; hitsTaken = 0; playSound(80, 0.4, 'sawtooth');
            if (lives <= 0) state = 'GAMEOVER'; else { player.x = 30; player.y = 300; }
        }

        [...safePlatforms, ...elevators].forEach(el => {
            if (el.dir) { el.y += el.dir * el.speed; if (el.y < 80 || el.y > 330) el.dir *= -1; }
            if (player.x + 15 > el.x && player.x < el.x + el.w && player.y + 40 > el.y && player.y + 40 < el.y + 15 && player.vy >= 0) {
                player.y = el.y - 40; player.vy = el.dir ? el.dir * el.speed : 0; player.grounded = true;
            }
        });
        if (player.x > 770) { state = 'LEVEL2'; spawnEnemy(); }
    } 
    else if (state === 'LEVEL2') {
        if (currentEnemy) {
            currentEnemy.timer++;
            if (currentEnemy.timer >= currentEnemy.maxTime) {
                hitsTaken++;
                playSound(120, 0.2, 'sawtooth', 0.3); // Enemy hit sound
                currentEnemy.timer = 0;
                if (hitsTaken >= 2) { lives--; hitsTaken = 0; }
                if (lives <= 0) state = 'GAMEOVER';
            }
        }
        if (mouse.clicked && player.recoil <= 0) {
            player.recoil = 25;
            player.muzzleFlash = 4;
            playSniperShot();
            if (keys['Space'] && currentEnemy) {
                const scopeY = mouse.y - player.recoil;
                if (Math.abs(mouse.x - currentEnemy.x) < 25 && Math.abs(scopeY - currentEnemy.y) < 45) {
                    targetsEliminated++; hitsTaken = 0;
                    if (targetsEliminated >= 20) state = 'WIN'; else spawnEnemy();
                }
            }
        }
        if (player.recoil > 0) player.recoil -= 2;
    } 
    else if (state === 'WIN') {
        if (heli.phase === 'approaching') {
            heli.x += 3; if (heli.x >= 350) heli.phase = 'hovering';
        } else if (heli.phase === 'hovering') {
            player.winAnimY -= 1.5;
            if (player.winAnimY < 120) heli.phase = 'exiting';
        } else {
            heli.x += 6; heli.y -= 1.5;
        }
    }
    mouse.clicked = false;
}

function draw() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    document.getElementById('livesText').innerText = `LIVES: ${lives} | HITS: ${hitsTaken}/2`;
    document.getElementById('scoreText').innerText = `TARGETS: ${targetsEliminated}/20`;

    if (state === 'LEVEL1') {
        // Floor Glow
        ctx.fillStyle = `rgba(0, 100, 255, ${0.3 + Math.random()*0.2})`;
        ctx.fillRect(0, 430, 800, 20);
        ctx.fillStyle = "#333"; safePlatforms.forEach(p => ctx.fillRect(p.x, p.y, p.w, p.h));
        elevators.forEach(el => {
            ctx.strokeStyle = "#444"; ctx.beginPath(); ctx.moveTo(el.x+el.w/2, 0); ctx.lineTo(el.x+el.w/2, el.y); ctx.stroke();
            ctx.fillStyle = "#555"; ctx.fillRect(el.x, el.y, el.w, el.h); 
            ctx.fillStyle = "#222"; ctx.fillRect(el.x, el.y - 5, el.w, 5); // Roof
        });
        drawStickman(player.x, player.y, "white");
    } 
    else if (state === 'LEVEL2') {
        // Background
        ctx.fillStyle = "#050510";
        for(let i=0; i<10; i++) ctx.fillRect(i*90, 260 + (i%3)*20, 75, 200);
        
        if (currentEnemy) {
            const danger = currentEnemy.timer / currentEnemy.maxTime;
            drawStickman(currentEnemy.x, currentEnemy.y, `rgb(255, ${255-(danger*255)}, ${255-(danger*255)})`);
        }

        if (keys['Space']) {
            ctx.save(); ctx.beginPath(); ctx.rect(0, 0, 800, 450);
            ctx.arc(mouse.x, mouse.y - player.recoil, 90, 0, Math.PI * 2, true);
            ctx.fillStyle = "rgba(0,0,0,0.94)"; ctx.fill();
            ctx.strokeStyle = "#0f0"; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(mouse.x, mouse.y - player.recoil, 90, 0, Math.PI * 2); ctx.stroke();
            ctx.moveTo(mouse.x-40, mouse.y-player.recoil); ctx.lineTo(mouse.x+40, mouse.y-player.recoil);
            ctx.moveTo(mouse.x, mouse.y-player.recoil-40); ctx.lineTo(mouse.x, mouse.y-player.recoil+40);
            ctx.stroke(); ctx.restore();
        }
        if (player.muzzleFlash > 0) {
            ctx.fillStyle = "rgba(255,255,255,0.3)"; ctx.fillRect(0,0,800,450);
            player.muzzleFlash--;
        }
    } 
    else if (state === 'WIN') {
        // Heli
        ctx.fillStyle = "#444"; ctx.fillRect(heli.x, heli.y, 100, 40);
        ctx.fillStyle = "#000"; ctx.fillRect(heli.x-30, heli.y-5, 160, 4); // Blades
        // Ladder
        ctx.strokeStyle = "#532"; ctx.lineWidth = 2;
        ctx.beginPath(); ctx.moveTo(heli.x+40, heli.y+40); ctx.lineTo(heli.x+40, heli.y+350);
        ctx.moveTo(heli.x+60, heli.y+40); ctx.lineTo(heli.x+60, heli.y+350);
        for(let i=0; i<12; i++) { ctx.moveTo(heli.x+40, heli.y+60+(i*25)); ctx.lineTo(heli.x+60, heli.y+60+(i*25)); }
        ctx.stroke();
        drawStickman(heli.x + 35, player.winAnimY, "white");
        ctx.fillStyle = "#0f0"; ctx.font = "24px Arial"; ctx.fillText("EXTRACTION IN PROGRESS...", 250, 420);
        if (heli.x > 850) { ctx.font = "40px Arial"; ctx.fillText("YOU WIN", 320, 225); }
    }
    else if (state === 'GAMEOVER') {
        ctx.fillStyle = "red"; ctx.font = "40px Arial"; ctx.fillText("MISSION FAILED - KIA", 200, 225);
    }
    requestAnimationFrame(() => { update(); draw(); });
}

function drawStickman(x, y, color) {
    ctx.strokeStyle = color; ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x+10, y+5, 5, 0, Math.PI*2); // Head
    ctx.moveTo(x+10, y+10); ctx.lineTo(x+10, y+25); // Body
    ctx.moveTo(x+10, y+25); ctx.lineTo(x, y+40); ctx.moveTo(x+10, y+25); ctx.lineTo(x+20, y+40); // Legs
    ctx.moveTo(x+10, y+15); ctx.lineTo(x-2, y+22); ctx.moveTo(x+10, y+15); ctx.lineTo(x+22, y+22); // Arms
    ctx.stroke();
    ctx.fillStyle = "black"; ctx.fillRect(x, y-2, 20, 4); ctx.fillRect(x+4, y-8, 12, 6); // Hat
}

draw();
</script>
</body>
</html>